---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<div id={`comments-${slug}`} class="comments-section">
  <h3>Comments</h3>

  <form class="comment-form">
    <div style="margin-bottom: var(--spacing-sm);">
      <label for="name" style="display: block; margin-bottom: var(--spacing-xs); font-weight: 600;">
        Name
      </label>
      <input type="text" id="name" name="name" required />
    </div>

    <div style="margin-bottom: var(--spacing-sm);">
      <label for="comment" style="display: block; margin-bottom: var(--spacing-xs); font-weight: 600;">
        Comment
      </label>
      <textarea id="comment" name="comment" rows="4" required></textarea>
    </div>

    <button type="submit">Post Comment</button>
  </form>

  <div class="comments-list" style="margin-top: var(--spacing-lg);"></div>
</div>

<style>
  .comment-item {
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    margin-bottom: var(--spacing-sm);
  }

  .comment-header {
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
  }

  .comment-date {
    color: var(--color-hover);
    font-size: 0.85rem;
    margin-left: var(--spacing-xs);
  }

  .comment-body {
    margin-top: var(--spacing-xs);
  }
</style>

<script define:vars={{ slug }}>
  const storageKey = `comments-${slug}`;
  const form = document.querySelector(`#comments-${slug} .comment-form`);
  const commentsList = document.querySelector(`#comments-${slug} .comments-list`);

  // Load comments
  function loadComments() {
    const comments = JSON.parse(localStorage.getItem(storageKey) || '[]');

    if (comments.length === 0) {
      commentsList.innerHTML = '<p style="color: var(--color-hover);">No comments yet. Be the first to comment!</p>';
      return;
    }

    commentsList.innerHTML = comments
      .map((comment) => `
        <div class="comment-item">
          <div class="comment-header">
            ${comment.name}
            <span class="comment-date">${new Date(comment.date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}</span>
          </div>
          <div class="comment-body">${comment.comment}</div>
        </div>
      `)
      .join('');
  }

  loadComments();

  // Handle form submission
  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const name = formData.get('name');
    const comment = formData.get('comment');

    const comments = JSON.parse(localStorage.getItem(storageKey) || '[]');
    comments.push({
      name,
      comment,
      date: new Date().toISOString(),
    });

    localStorage.setItem(storageKey, JSON.stringify(comments));
    form.reset();
    loadComments();
  });
</script>
